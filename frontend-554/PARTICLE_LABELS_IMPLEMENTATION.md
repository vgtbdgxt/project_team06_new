# 粒子标签功能实现说明

## 实现方法

### 目标
为首页粒子动画添加交互式标签功能，当鼠标悬停在画布上时，在靠近光标且视觉上靠前的粒子旁边显示对应心理健康诊所的信息。

### 核心设计

#### 1. 数据绑定
- 创建静态诊所数据数组，包含名称、州和评分信息
- 通过索引模运算将粒子映射到诊所：`clinicIndex = particleIndex % clinics.length`
- 这样即使粒子数量与诊所数量不同，也能确保每个粒子都有对应的诊所数据

#### 2. 粒子选择算法
在鼠标移动时，选择要显示标签的粒子：
- **距离筛选**：计算每个粒子到鼠标光标的欧几里得距离
- **深度判断**：使用粒子的 `size` 属性作为深度指标（较大的粒子通常更靠前）
- **综合评分**：结合距离和大小，选择距离近且尺寸大的粒子
- **数量限制**：只显示最符合条件的 3-5 个粒子标签，避免界面混乱

#### 3. 标签渲染
- **位置**：标签显示在粒子位置右上方，使用固定偏移量（如 +15px x, -10px y）
- **样式**：
  - 字体：细体，10px 字号
  - 颜色：白色，低透明度（约 0.6-0.8）
  - 背景：可选半透明背景以提高可读性
- **格式**：`诊所名称, 州简称 · 评分`

#### 4. 性能优化
- 标签渲染在现有的 `animate()` 循环中进行
- 使用距离阈值（如 150px）过滤掉过远的粒子
- 只在鼠标移动时重新计算候选粒子列表

### 实现细节

#### 代码修改位置
1. **数据定义**：在粒子系统初始化前添加诊所数组
2. **粒子类扩展**：为 Particle 类添加 `clinicIndex` 属性
3. **鼠标事件处理**：扩展现有的 `mousemove` 事件处理
4. **渲染函数**：在 `animate()` 函数中添加标签绘制逻辑

#### 关键函数
- `getClosestParticles(mouseX, mouseY, count)`: 获取最靠近鼠标的粒子
- `drawLabel(ctx, particle, clinic)`: 在指定位置绘制标签文本

### 可调参数

#### 标签数量
在代码顶部找到以下常量定义：
```javascript
const MAX_LABELS = 3; // 修改此值以调整同时显示的标签数量（建议 3-5）
```

#### 标签样式
在 `drawLabel` 函数中调整以下参数：

1. **字体大小和样式**（第 3 行附近）：
```javascript
ctx.font = '300 10px Arial, sans-serif';
// 格式：'weight size family'
// 300 = 细体，10px = 字号，可调整为 8-12px
```

2. **标签位置偏移**（第 5-6 行附近）：
```javascript
const offsetX = 15;  // 水平偏移（像素），正值向右
const offsetY = -10; // 垂直偏移（像素），负值向上
```

3. **文本颜色和透明度**（第 20 行附近）：
```javascript
ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
// 最后一个值（0.7）是透明度，范围 0-1，可调整为 0.5-0.9
```

4. **背景颜色和透明度**（第 15 行附近）：
```javascript
ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
// 背景透明度，可调整为 0.2-0.6 以改变背景深浅
```

#### 选择范围
在代码顶部找到以下常量：
```javascript
const MAX_DISTANCE = 150; // 最大选择距离（像素）
// 增大此值会显示更远粒子的标签，减小则只显示很近的粒子
// 建议范围：100-200px
```

#### 选择算法权重调整
如果需要调整距离和尺寸的权重比例，在 `getClosestParticles` 函数中修改评分公式（约第 8 行）：
```javascript
// 当前公式：score = (1 / (distance + 1)) * particle.size
// 如果想更重视距离，可以增加距离的权重：
// const score = (1 / (distance + 1)) * 2 * particle.size;
// 如果想更重视尺寸，可以增加尺寸的权重：
// const score = (1 / (distance + 1)) * particle.size * 2;
```

## 文件修改清单

### 修改的文件
- **`index.html`**: 唯一修改的文件

### 具体修改内容

1. **添加诊所数据数组**（约第 25-110 行）
   - 创建包含 100 个诊所的静态数据数组
   - 每个诊所包含：名称、州名、评分

2. **添加配置常量**（约第 112-117 行）
   - `MAX_LABELS`: 最大标签数量
   - `MAX_DISTANCE`: 最大选择距离

3. **扩展 Particle 类**（约第 478-499 行）
   - 构造函数添加 `index` 参数
   - 添加 `clinicIndex` 属性，通过模运算映射到诊所数据

4. **修改 initWorld 函数**（约第 557-568 行）
   - 在创建粒子时传递索引参数

5. **添加 getClosestParticles 函数**（约第 570-600 行）
   - 实现粒子选择算法
   - 综合距离和尺寸进行评分排序

6. **添加 drawLabel 函数**（约第 602-640 行）
   - 实现标签绘制逻辑
   - 包含文本格式化、位置计算、样式设置

7. **修改 animate 函数**（约第 642-665 行）
   - 在渲染循环中添加标签绘制调用
   - 使用 `source-over` 模式确保标签清晰

8. **修改 mousedown 事件处理**（约第 667-675 行）
   - 为新创建的粒子正确分配诊所索引

## 使用说明

### 功能说明
- 当鼠标移动到画布上时，系统会自动检测附近的粒子
- 选择距离近且尺寸大的粒子（视觉上靠前）
- 在选中的粒子旁边显示对应的诊所信息标签
- 标签格式：`诊所名称, 州简称 · 评分`

### 交互体验
- 标签会随着鼠标移动实时更新
- 最多同时显示 3 个标签（可通过 `MAX_LABELS` 调整）
- 标签样式低调，不会干扰粒子动画效果
- 标签有半透明背景，确保在不同背景下可读

### 性能考虑
- 标签渲染在每帧动画循环中进行，性能开销很小
- 使用距离阈值过滤，避免处理所有粒子
- 只对最符合条件的少数粒子进行标签绘制

